<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” ØµÙŠØ¯Ø§Øª Ø§Ù„Ø¹ÙˆØ¯</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=Tajawal:wght@500;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/variables.css">
<link rel="stylesheet" href="css/reset.css">
<link rel="stylesheet" href="css/layout.css">
<link rel="stylesheet" href="css/buttons.css">
<link rel="stylesheet" href="css/forms.css">
<link rel="stylesheet" href="css/badges.css">
<link rel="stylesheet" href="css/dashboard.css">
</head>
<body>

<!-- SIDEBAR OVERLAY (mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- MOBILE TOGGLE -->
<button class="mobile-toggle" id="mobileToggle" onclick="toggleSidebar()">â˜°</button>

<div class="dashboard-layout">
  <!-- ===== SIDEBAR ===== -->
  <aside class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-brand">
      <img src="logo.svg" alt="ØµÙŠØ¯Ø§Øª Ø§Ù„Ø¹ÙˆØ¯">
      <span class="sidebar-brand-text">ØµÙŠØ¯Ø§Øª Ø§Ù„Ø¹ÙˆØ¯</span>
    </a>

    <div class="sidebar-user" id="sidebarUser">
      <div class="sidebar-avatar" id="sidebarAvatar">Ù…</div>
      <div class="sidebar-user-info">
        <div class="sidebar-user-name" id="sidebarName">Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø®Ø¶ÙŠØ±</div>
        <div class="sidebar-user-role">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm-1.25 17.47l-4.82-4.82 1.41-1.41 3.41 3.41 7.2-7.2 1.41 1.42-8.61 8.6z"/></svg>
          ØªØ§Ø¬Ø± Ù…ÙˆØ«Ù‚
        </div>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-label">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>

      <button class="nav-item active" data-section="overview" onclick="switchSection('overview')">
        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
        Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
      </button>

      <button class="nav-item" data-section="products" onclick="switchSection('products')">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z"/></svg>
        Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      </button>

      <button class="nav-item" data-section="orders" onclick="switchSection('orders')">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        <span class="badge-count" id="newOrdersCount">2</span>
      </button>

      <button class="nav-item" data-section="finance" onclick="switchSection('finance')">
        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
        Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      </button>

      <div class="nav-section-label" style="margin-top: 12px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

      <button class="nav-item" data-section="profile" onclick="switchSection('profile')">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
      </button>
    </nav>

    <div class="sidebar-footer">
      <button class="nav-item logout-item" onclick="AUTH.logout()">
        <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main class="main-content">
    <div class="content-header">
      <h1 id="pageTitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h1>
      <div class="header-actions-bar">
        <a href="index.html" class="btn-back">
          <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹
        </a>
      </div>
    </div>

    <div class="content-body">

      <!-- ============================== -->
      <!-- OVERVIEW SECTION               -->
      <!-- ============================== -->
      <div class="section-panel active" id="section-overview">
        <div class="stats-grid" id="statsGrid">
          <!-- Filled by JS -->
        </div>

        <div class="chart-card">
          <div class="chart-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
          <div class="bar-chart" id="barChart">
            <!-- Filled by JS -->
          </div>
        </div>

        <div class="table-card">
          <div class="table-header">
            <span class="table-title">Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            <button class="btn btn-outline btn-sm" onclick="switchSection('orders')">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
              </thead>
              <tbody id="recentOrdersBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================== -->
      <!-- PRODUCTS SECTION               -->
      <!-- ============================== -->
      <div class="section-panel" id="section-products">
        <div class="table-card">
          <div class="table-header">
            <span class="table-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</span>
            <button class="btn btn-primary btn-sm" onclick="openAddChooser()">
              <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
              Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
            </button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                  <th>Ø§Ù„Ù…Ù†Ø´Ø£</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="productsBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================== -->
      <!-- ORDERS SECTION                 -->
      <!-- ============================== -->
      <div class="section-panel" id="section-orders">
        <div class="tabs" id="orderTabs">
          <button class="tab-btn active" data-tab="all" onclick="filterOrders('all')">Ø§Ù„ÙƒÙ„ <span class="count" id="countAll">0</span></button>
          <button class="tab-btn" data-tab="new" onclick="filterOrders('new')">Ø¬Ø¯ÙŠØ¯Ø© <span class="count" id="countNew">0</span></button>
          <button class="tab-btn" data-tab="processing" onclick="filterOrders('processing')">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© <span class="count" id="countProcessing">0</span></button>
          <button class="tab-btn" data-tab="completed" onclick="filterOrders('completed')">Ù…ÙƒØªÙ…Ù„Ø© <span class="count" id="countCompleted">0</span></button>
          <button class="tab-btn" data-tab="cancelled" onclick="filterOrders('cancelled')">Ù…Ù„ØºÙŠØ© <span class="count" id="countCancelled">0</span></button>
        </div>

        <div class="table-card">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                  <th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø´Ø­Ù†</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="ordersBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================== -->
      <!-- FINANCE SECTION                -->
      <!-- ============================== -->
      <div class="section-panel" id="section-finance">
        <div class="balance-card">
          <div class="balance-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</div>
          <div class="balance-amount" id="balanceAmount">0 <span>Ø±.Ø³</span></div>
          <div class="balance-actions">
            <button class="btn-withdraw" onclick="openWithdrawModal()">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
          </div>
        </div>

        <div class="finance-stats" id="financeStats">
          <!-- Filled by JS -->
        </div>

        <div class="table-card">
          <div class="table-header">
            <span class="table-title">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</span>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody id="transactionsBody">
                <!-- Filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ============================== -->
      <!-- PROFILE SECTION                -->
      <!-- ============================== -->
      <div class="section-panel" id="section-profile">
        <div class="profile-section">
          <div class="profile-section-title">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
          </div>
          <div class="profile-avatar-row">
            <div class="profile-avatar-lg" id="profileAvatar">Ù…</div>
            <div class="profile-avatar-info">
              <h3 id="profileFullName">Ù…Ø§Ø¬Ø¯ Ø§Ù„Ø®Ø¶ÙŠØ±</h3>
              <p>Ø¹Ø¶Ùˆ Ù…Ù†Ø° ÙŠÙ†Ø§ÙŠØ± 2026</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
              <input type="text" class="form-input" id="profFirstName" value="">
            </div>
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ±</label>
              <input type="text" class="form-input" id="profLastName" value="">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
              <input type="email" class="form-input" id="profEmail" value="">
            </div>
            <div class="form-group">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
              <input type="tel" class="form-input" id="profPhone" value="">
            </div>
          </div>
        </div>

        <div class="profile-section">
          <div class="profile-section-title">
            <svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg>
            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label>
            <input type="text" class="form-input" id="profStoreName" value="">
          </div>
          <div class="form-group">
            <label class="form-label">ÙˆØµÙ Ø§Ù„Ù…ØªØ¬Ø±</label>
            <textarea class="form-textarea" id="profStoreDesc"></textarea>
          </div>
        </div>

        <!-- ===== Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ===== -->
        <div class="profile-section">
          <div class="profile-section-title">
            <svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm-1.25 17.47l-4.82-4.82 1.41-1.41 3.41 3.41 7.2-7.2 1.41 1.42-8.61 8.6z"/></svg>
            Ø§Ù„ØªÙˆØ«ÙŠÙ‚
          </div>

          <!-- Ø­Ø§Ù„Ø© ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªØ§Ø¬Ø± -->
          <div class="verify-status-card" id="merchantVerifyCard">
            <div class="verify-status-header">
              <span class="verify-icon merchant">ğŸª</span>
              <div>
                <strong>ØªØ§Ø¬Ø± Ù…ÙˆØ«Ù‚</strong>
                <p class="verify-desc">ÙˆØ«Ù‘Ù‚ Ø­Ø³Ø§Ø¨Ùƒ ÙƒØªØ§Ø¬Ø± Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</p>
              </div>
              <span class="verify-badge" id="merchantBadge">ØºÙŠØ± Ù…ÙˆØ«Ù‚</span>
            </div>
            <div id="merchantVerifyForm" class="verify-form">
              <div class="form-group" style="margin-bottom: 12px;">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
                <input type="text" class="form-input" id="profCommercialRegister" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ" style="direction: ltr; text-align: right;">
              </div>
              <button class="btn btn-outline btn-sm" onclick="submitMerchantVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚</button>
            </div>
          </div>

          <!-- Ø­Ø§Ù„Ø© ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹ -->
          <div class="verify-status-card" id="sellerVerifyCard" style="margin-top: 16px;">
            <div class="verify-status-header">
              <span class="verify-icon seller">â­</span>
              <div>
                <strong>Ø¨Ø§Ø¦Ø¹ Ù…ÙˆØ«Ù‚</strong>
                <p class="verify-desc">ÙŠÙÙ…Ù†Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø¨ÙŠØ¹ Ù…Ø²Ø§Ø¯ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­</p>
              </div>
              <span class="verify-badge" id="sellerBadge">ØºÙŠØ± Ù…ÙˆØ«Ù‚</span>
            </div>
            <div class="verify-progress">
              <div class="verify-progress-bar">
                <div class="verify-progress-fill" id="auctionProgressFill" style="width: 0%"></div>
              </div>
              <span class="verify-progress-text" id="auctionProgressText">0 / 2 Ù…Ø²Ø§Ø¯ Ù…ÙƒØªÙ…Ù„</span>
            </div>
          </div>
        </div>

        <div class="profile-section">
          <div class="profile-section-title">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
            Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ø§Ù„Ø¨Ù†Ùƒ</label>
              <select class="form-select" id="profBankName">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ</option>
                <option value="Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ">Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</option>
                <option value="Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ">Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ</option>
                <option value="Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶">Ø¨Ù†Ùƒ Ø§Ù„Ø±ÙŠØ§Ø¶</option>
                <option value="Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡">Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ù†Ù…Ø§Ø¡</option>
                <option value="Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ">Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ</option>
                <option value="Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯">Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ù„Ø§Ø¯</option>
                <option value="Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©">Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label>
              <input type="text" class="form-input" id="profBankHolder" value="">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù† (IBAN)</label>
            <input type="text" class="form-input" id="profIban" value="" placeholder="SA0000000000000000000000" style="direction: ltr; text-align: left;">
          </div>
        </div>

        <div class="profile-section">
          <div class="profile-section-title">
            <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          </div>
          <div class="form-group">
            <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <input type="password" class="form-input" id="profCurrentPass">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
              <input type="password" class="form-input" id="profNewPass">
            </div>
            <div class="form-group">
              <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input type="password" class="form-input" id="profConfirmPass">
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-start;">
          <button class="btn btn-primary" onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
          <button class="btn btn-outline" onclick="loadProfile()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>

    </div><!-- content-body -->
  </main>
</div><!-- dashboard-layout -->

<!-- ===== ADD CHOOSER MODAL ===== -->
<div class="modal-overlay" id="addChooserModal">
  <div class="modal" style="max-width: 480px;">
    <div class="modal-header">
      <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h2>
      <button class="modal-close" onclick="closeAddChooser()">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size: 0.88rem; margin-bottom: 20px; opacity: 0.7;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø·Ø±Ø­ Ø§Ù„Ù…Ù†ØªØ¬:</p>
      <div class="listing-chooser">
        <div class="chooser-card" onclick="chooseListingType('market')">
          <div class="chooser-icon market-icon">
            <svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg>
          </div>
          <div class="chooser-title">Ø·Ø±Ø­ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚</div>
          <div class="chooser-desc">Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø³Ø¹Ø± Ø«Ø§Ø¨Øª</div>
        </div>
        <div class="chooser-card" onclick="chooseListingType('auction')">
          <div class="chooser-icon auction-icon">
            <svg viewBox="0 0 24 24"><path d="M17.65 6.35a7.95 7.95 0 0 0-11.3 0L12 12l5.65-5.65zM12 22c5.52 0 10-4.48 10-10h-4c0 3.31-2.69 6-6 6s-6-2.69-6-6H2c0 5.52 4.48 10 10 10z"/></svg>
          </div>
          <div class="chooser-title">Ù…Ø²Ø§Ø¯</div>
          <div class="chooser-desc">Ù…Ø²Ø§Ø¯ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PRODUCT MODAL ===== -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="productModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
      <button class="modal-close" onclick="closeProductModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editProductId" value="">
      <input type="hidden" id="pmListingType" value="market">

      <!-- AUCTION FIELDS (shown only for auction) -->
      <div class="auction-fields" id="auctionFields">
        <div class="auction-fields-title">
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35a7.95 7.95 0 0 0-11.3 0L12 12l5.65-5.65zM12 22c5.52 0 10-4.48 10-10h-4c0 3.31-2.69 6-6 6s-6-2.69-6-6H2c0 5.52 4.48 10 10 10z"/></svg>
          Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¯
        </div>

        <div class="auction-type-toggle">
          <button type="button" class="auction-type-btn selected" data-atype="timed" onclick="selectAuctionType('timed')">
            Ù…Ø­Ø¯Ø¯ Ø¨ÙˆÙ‚Øª
            <small>ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ Ù…Ø¯Ø© Ù…Ø¹ÙŠÙ†Ø©</small>
          </button>
          <button type="button" class="auction-type-btn" data-atype="until_sold" onclick="selectAuctionType('until_sold')">
            Ù…Ù†ØªÙ‡ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ¹
            <small>ÙŠØ³ØªÙ…Ø± Ø­ØªÙ‰ ÙŠÙ‚Ø¨Ù„ Ø§Ù„ØªØ§Ø¬Ø± Ø¹Ø±Ø¶Ø§Ù‹</small>
          </button>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Ø±.Ø³)</label>
            <input type="number" class="form-input" id="pmStartPrice" placeholder="100" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø²Ø§ÙŠØ¯Ø© (Ø±.Ø³)</label>
            <input type="number" class="form-input" id="pmMinBid" placeholder="10" min="1">
          </div>
        </div>

        <div class="form-group" id="auctionDurationGroup">
          <label class="form-label">Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ø¯</label>
          <select class="form-select" id="pmAuctionDuration">
            <option value="1">ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯</option>
            <option value="3" selected>3 Ø£ÙŠØ§Ù…</option>
            <option value="5">5 Ø£ÙŠØ§Ù…</option>
            <option value="7">7 Ø£ÙŠØ§Ù…</option>
            <option value="14">14 ÙŠÙˆÙ…</option>
            <option value="30">30 ÙŠÙˆÙ…</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„ÙÙˆØ±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="number" class="form-input" id="pmBuyNow" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø°ÙŠ ÙŠÙÙ†Ù‡ÙŠ Ø§Ù„Ù…Ø²Ø§Ø¯ ÙÙˆØ±Ø§Ù‹" min="0">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input type="text" class="form-input" id="pmName" placeholder="Ù…Ø«Ø§Ù„: Ø¹ÙˆØ¯ ÙƒÙ…Ø¨ÙˆØ¯ÙŠ ÙØ§Ø®Ø±">
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
          <select class="form-select" id="pmCategory">
            <option value="Ø¨Ø®ÙˆØ±">Ø¨Ø®ÙˆØ±</option>
            <option value="Ø¯Ù‡Ù† Ø¹ÙˆØ¯">Ø¯Ù‡Ù† Ø¹ÙˆØ¯</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
          <select class="form-select" id="pmType">
            <option value="Ø·Ø¨ÙŠØ¹ÙŠ">Ø·Ø¨ÙŠØ¹ÙŠ</option>
            <option value="Ù…Ø­Ø³Ù†">Ù…Ø­Ø³Ù†</option>
            <option value="Ø¨ÙŠÙˆØ±">Ø¨ÙŠÙˆØ±</option>
            <option value="Ù…Ø®Ù„Ø·">Ù…Ø®Ù„Ø·</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ù…Ù†Ø´Ø£</label>
          <select class="form-select" id="pmOrigin">
            <option value="ÙƒÙ…Ø¨ÙˆØ¯ÙŠ">ÙƒÙ…Ø¨ÙˆØ¯ÙŠ</option>
            <option value="Ù‡Ù†Ø¯ÙŠ">Ù‡Ù†Ø¯ÙŠ</option>
            <option value="Ù„Ø§ÙˆØ³ÙŠ">Ù„Ø§ÙˆØ³ÙŠ</option>
            <option value="ÙÙŠØªÙ†Ø§Ù…ÙŠ">ÙÙŠØªÙ†Ø§Ù…ÙŠ</option>
            <option value="Ù…Ø§Ù„ÙŠØ²ÙŠ">Ù…Ø§Ù„ÙŠØ²ÙŠ</option>
            <option value="Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠ">Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠ</option>
            <option value="Ø¨ÙˆØ±Ù…ÙŠ">Ø¨ÙˆØ±Ù…ÙŠ</option>
            <option value="ØªØ§ÙŠÙ„Ù†Ø¯ÙŠ">ØªØ§ÙŠÙ„Ù†Ø¯ÙŠ</option>
            <option value="Ø³Ø±ÙŠÙ„Ø§Ù†ÙƒÙŠ">Ø³Ø±ÙŠÙ„Ø§Ù†ÙƒÙŠ</option>
            <option value="Ø¨Ø§Ø¨ÙˆØ§Ø²ÙŠ">Ø¨Ø§Ø¨ÙˆØ§Ø²ÙŠ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Ø§Ù„ÙˆØ²Ù†</label>
          <input type="number" class="form-input" id="pmWeight" placeholder="50" step="0.25" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select class="form-select" id="pmUnit">
            <option value="Ø¬Ø±Ø§Ù…">Ø¬Ø±Ø§Ù…</option>
            <option value="ØªÙˆÙ„Ø©">ØªÙˆÙ„Ø©</option>
            <option value="Ø£ÙˆÙ‚ÙŠØ©">Ø£ÙˆÙ‚ÙŠØ©</option>
            <option value="ÙƒÙŠÙ„Ùˆ">ÙƒÙŠÙ„Ùˆ</option>
          </select>
        </div>
      </div>
      <div class="form-row" id="priceStockRow">
        <div class="form-group" id="priceGroup">
          <label class="form-label" id="priceLabelText">Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label>
          <input type="number" class="form-input" id="pmPrice" placeholder="285" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
          <input type="number" class="form-input" id="pmStock" placeholder="10" min="0">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
        <input type="url" class="form-input" id="pmImage" placeholder="https://..." style="direction: ltr; text-align: left;">
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
        <textarea class="form-textarea" id="pmDesc" placeholder="ÙˆØµÙ Ù…ÙØµÙ„ Ù„Ù„Ù…Ù†ØªØ¬..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
      <button class="btn btn-outline" onclick="closeProductModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ===== WITHDRAW MODAL ===== -->
<div class="modal-overlay" id="withdrawModal">
  <div class="modal" style="max-width: 480px;">
    <div class="modal-header">
      <h2>Ø·Ù„Ø¨ Ø³Ø­Ø¨</h2>
      <button class="modal-close" onclick="closeWithdrawModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</label>
        <input type="number" class="form-input" id="withdrawAmount" placeholder="0" min="100">
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input type="text" class="form-input" id="withdrawBank" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†</label>
        <input type="text" class="form-input" id="withdrawIban" readonly style="direction: ltr; text-align: left;">
      </div>
      <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 8px;">* ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø®Ù„Ø§Ù„ 1-3 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="submitWithdraw()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button>
      <button class="btn btn-outline" onclick="closeWithdrawModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ===== ORDER DETAIL MODAL (Enhanced) ===== -->
<div class="modal-overlay" id="orderDetailModal">
  <div class="modal" style="max-width: 680px;">
    <div class="modal-header">
      <h2 id="orderDetailTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
      <button class="modal-close" onclick="closeOrderDetail()">&#10005;</button>
    </div>
    <div class="modal-body" id="orderDetailBody">
      <!-- Filled by JS: order info, address, shipping, timeline -->
    </div>
    <div class="modal-footer" id="orderDetailFooter">
      <!-- Filled by JS: contextual action buttons -->
    </div>
  </div>
</div>

<!-- ===== WAYBILL MODAL ===== -->
<div class="modal-overlay" id="waybillModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2>Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„Ø´Ø­Ù†</h2>
      <button class="modal-close" onclick="closeWaybillModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="waybillOrderId" value="">
      <div class="form-group">
        <label class="form-label">Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</label>
        <select class="form-select" id="waybillCarrier" onchange="onWaybillCarrierChange()">
          <option value="">Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</option>
          <option value="aramex">Aramex - Ø£Ø±Ø§Ù…ÙƒØ³</option>
          <option value="smsa">SMSA Express</option>
          <option value="spl">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ - SPL</option>
          <option value="other">Ø´Ø±ÙƒØ© Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div class="form-group" id="customCarrierGroup" style="display:none;">
        <label class="form-label">Ø§Ø³Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</label>
        <input type="text" class="form-input" id="waybillCustomCarrier" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†">
      </div>
      <div class="form-group">
        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹</label>
        <input type="text" class="form-input" id="waybillTracking" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹" style="direction: ltr; text-align: left;">
      </div>
      <!-- Waybill Preview (printable area) -->
      <div class="waybill-preview" id="waybillPreview"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="saveAndPrintWaybill()">Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©</button>
      <button class="btn btn-outline" onclick="closeWaybillModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ===== REJECT REASON MODAL ===== -->
<div class="modal-overlay" id="rejectModal">
  <div class="modal" style="max-width: 440px;">
    <div class="modal-header">
      <h2>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</h2>
      <button class="modal-close" onclick="closeRejectModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="rejectOrderId" value="">
      <div class="form-group">
        <label class="form-label">Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</label>
        <select class="form-select" id="rejectReason" onchange="onRejectReasonChange()">
          <option value="Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±</option>
          <option value="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±</option>
          <option value="Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­">Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­</option>
          <option value="other">Ø³Ø¨Ø¨ Ø¢Ø®Ø±</option>
        </select>
      </div>
      <div class="form-group" id="customRejectGroup" style="display:none;">
        <label class="form-label">Ø§Ø°ÙƒØ± Ø§Ù„Ø³Ø¨Ø¨</label>
        <textarea class="form-textarea" id="rejectCustomReason" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="confirmRejectOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶</button>
      <button class="btn btn-outline" onclick="closeRejectModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase.js"></script>
<script src="auth.js"></script>
<script>
// ===== DASHBOARD APP =====
var currentUser = null;
var currentOrderFilter = 'all';

// ===== INIT =====
async function initDashboard() {
  // Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Supabase
  await AUTH.ready();

  currentUser = AUTH.getCurrentUser();
  if (!currentUser) {
    window.location.href = 'login.html';
    return;
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  try {
    var products = await AUTH.getProducts();
    var orders = await AUTH.getOrders();
    var transactions = await AUTH.getTransactions();
    var monthlySales = await AUTH.getMonthlySales();

    currentUser.products = products || [];
    currentUser.orders = orders || [];
    currentUser.transactions = transactions || [];
    currentUser.monthlySales = monthlySales.length > 0 ? monthlySales : [
      { month: 'Ø³Ø¨ØªÙ…Ø¨Ø±', amount: 0 },
      { month: 'Ø£ÙƒØªÙˆØ¨Ø±', amount: 0 },
      { month: 'Ù†ÙˆÙÙ…Ø¨Ø±', amount: 0 },
      { month: 'Ø¯ÙŠØ³Ù…Ø¨Ø±', amount: 0 },
      { month: 'ÙŠÙ†Ø§ÙŠØ±', amount: 0 },
      { month: 'ÙØ¨Ø±Ø§ÙŠØ±', amount: 0 }
    ];
  } catch(e) {
    console.warn('Data load error:', e);
    currentUser.products = [];
    currentUser.orders = [];
    currentUser.transactions = [];
    currentUser.monthlySales = [
      { month: 'Ø³Ø¨ØªÙ…Ø¨Ø±', amount: 0 },
      { month: 'Ø£ÙƒØªÙˆØ¨Ø±', amount: 0 },
      { month: 'Ù†ÙˆÙÙ…Ø¨Ø±', amount: 0 },
      { month: 'Ø¯ÙŠØ³Ù…Ø¨Ø±', amount: 0 },
      { month: 'ÙŠÙ†Ø§ÙŠØ±', amount: 0 },
      { month: 'ÙØ¨Ø±Ø§ÙŠØ±', amount: 0 }
    ];
  }

  updateSidebar();
  renderOverview();
  renderProducts();
  renderOrders();
  renderFinance();
  loadProfile();

  // Handle hash navigation
  var hash = window.location.hash.replace('#', '');
  if (hash && document.getElementById('section-' + hash)) {
    switchSection(hash);
  }
}

// ===== SIDEBAR =====
function updateSidebar() {
  var initial = currentUser.firstName.charAt(0);
  document.getElementById('sidebarAvatar').textContent = initial;
  document.getElementById('sidebarName').textContent = currentUser.firstName + ' ' + currentUser.lastName;

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
  var roleEl = document.querySelector('.sidebar-user-role');
  if (roleEl) {
    var isMerchant = currentUser.merchantVerified;
    var isSeller = currentUser.sellerVerified;
    var checkSvg = '<svg viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0zm-1.25 17.47l-4.82-4.82 1.41-1.41 3.41 3.41 7.2-7.2 1.41 1.42-8.61 8.6z"/></svg>';

    if (isMerchant && isSeller) {
      roleEl.innerHTML = checkSvg + ' ØªØ§Ø¬Ø± ÙˆØ¨Ø§Ø¦Ø¹ Ù…ÙˆØ«Ù‚';
      roleEl.className = 'sidebar-user-role verify-both';
    } else if (isMerchant) {
      roleEl.innerHTML = checkSvg + ' ØªØ§Ø¬Ø± Ù…ÙˆØ«Ù‚';
      roleEl.className = 'sidebar-user-role verify-merchant';
    } else if (isSeller) {
      roleEl.innerHTML = checkSvg + ' Ø¨Ø§Ø¦Ø¹ Ù…ÙˆØ«Ù‚';
      roleEl.className = 'sidebar-user-role verify-seller';
    } else {
      roleEl.innerHTML = 'Ø¨Ø§Ø¦Ø¹';
      roleEl.className = 'sidebar-user-role verify-none';
    }
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}

// ===== SECTION SWITCHING =====
function switchSection(section) {
  // Update nav
  document.querySelectorAll('.nav-item[data-section]').forEach(function(item) {
    item.classList.remove('active');
    if (item.dataset.section === section) item.classList.add('active');
  });

  // Update panels
  document.querySelectorAll('.section-panel').forEach(function(p) {
    p.classList.remove('active');
  });
  var panel = document.getElementById('section-' + section);
  if (panel) panel.classList.add('active');

  // Update title
  var titles = {
    overview: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©',
    products: 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª',
    orders: 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
    finance: 'Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
    profile: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ'
  };
  document.getElementById('pageTitle').textContent = titles[section] || '';

  // Update hash
  window.location.hash = section === 'overview' ? '' : section;

  // Close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// ===== FORMAT HELPERS =====
function formatNumber(n) {
  return Number(n).toLocaleString('ar-SA');
}

function formatCurrency(n) {
  return formatNumber(n) + ' Ø±.Ø³';
}

function statusLabel(status) {
  var map = {
    new: 'Ø¬Ø¯ÙŠØ¯',
    processing: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
    completed: 'Ù…ÙƒØªÙ…Ù„',
    cancelled: 'Ù…Ù„ØºÙŠ'
  };
  return '<span class="status status-' + status + '"><span class="status-dot"></span>' + (map[status] || status) + '</span>';
}

function typeLabel(type) {
  var map = {
    sale: 'Ø¨ÙŠØ¹',
    commission: 'Ø¹Ù…ÙˆÙ„Ø©',
    withdrawal: 'Ø³Ø­Ø¨'
  };
  return '<span class="status status-' + type + '">' + (map[type] || type) + '</span>';
}

// ===== OVERVIEW =====
function renderOverview() {
  var user = currentUser;
  var activeProducts = user.products.filter(function(p) { return p.active; }).length;

  var statsHTML =
    '<div class="stat-card">' +
      '<div class="stat-icon sales"><svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg></div>' +
      '<div class="stat-info"><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div><div class="stat-value">' + formatNumber(user.totalSales) + '</div><div class="stat-change up">â†‘ 12%</div></div>' +
    '</div>' +
    '<div class="stat-card">' +
      '<div class="stat-icon revenue"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></div>' +
      '<div class="stat-info"><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div><div class="stat-value">' + formatCurrency(user.totalRevenue) + '</div><div class="stat-change up">â†‘ 8%</div></div>' +
    '</div>' +
    '<div class="stat-card">' +
      '<div class="stat-icon balance"><svg viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div>' +
      '<div class="stat-info"><div class="stat-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</div><div class="stat-value">' + formatCurrency(user.balance) + '</div><div class="stat-change up">Ù…ØªØ§Ø­ Ù„Ù„Ø³Ø­Ø¨</div></div>' +
    '</div>' +
    '<div class="stat-card">' +
      '<div class="stat-icon products"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z"/></svg></div>' +
      '<div class="stat-info"><div class="stat-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div><div class="stat-value">' + activeProducts + '</div><div class="stat-change up">Ù…Ù† ' + user.products.length + ' Ù…Ù†ØªØ¬</div></div>' +
    '</div>';

  document.getElementById('statsGrid').innerHTML = statsHTML;

  // Chart
  var maxSales = Math.max.apply(null, user.monthlySales.map(function(m) { return m.amount; }));
  var chartHTML = '';
  user.monthlySales.forEach(function(m) {
    var height = maxSales > 0 ? Math.round((m.amount / maxSales) * 160) : 0;
    chartHTML +=
      '<div class="bar-group">' +
        '<div class="bar" style="height: ' + height + 'px">' +
          '<span class="bar-value">' + formatNumber(m.amount) + ' Ø±.Ø³</span>' +
        '</div>' +
        '<span class="bar-label">' + m.month + '</span>' +
      '</div>';
  });
  document.getElementById('barChart').innerHTML = chartHTML;

  // Recent orders
  var recent = user.orders.slice(0, 5);
  var ordersHTML = '';
  recent.forEach(function(o) {
    ordersHTML +=
      '<tr>' +
        '<td style="font-weight:600; font-size:0.82rem; direction:ltr; text-align:right;">' + o.id + '</td>' +
        '<td>' + o.productName + '</td>' +
        '<td>' + o.buyer + '</td>' +
        '<td style="font-weight:600;">' + formatCurrency(o.total) + '</td>' +
        '<td>' + statusLabel(o.status) + '</td>' +
        '<td style="font-size:0.82rem; opacity:0.7;">' + o.date + '</td>' +
      '</tr>';
  });
  document.getElementById('recentOrdersBody').innerHTML = ordersHTML;
}

// ===== PRODUCTS =====
function renderProducts() {
  var user = currentUser;
  var html = '';

  if (user.products.length === 0) {
    document.getElementById('productsBody').innerHTML = '<tr><td colspan="8"><div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 14H9v-2h6v2zm3-4H7v-2h10v2zm0-4H7V6h10v2z"/></svg><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</h3><p>Ø£Ø¶Ù Ù…Ù†ØªØ¬Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¢Ù†</p></div></td></tr>';
    return;
  }

  user.products.forEach(function(p) {
    var listingHTML = '';
    var priceHTML = '';
    if (p.listingType === 'auction') {
      var auctionTypeLabel = p.auctionType === 'until_sold' ? 'Ù…Ù†ØªÙ‡ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ¹' : 'Ù…Ø­Ø¯Ø¯ Ø¨ÙˆÙ‚Øª';
      var isLive = p.auctionStatus === 'live';
      var badgeClass = isLive ? 'badge-auction-live' : 'badge-auction';
      listingHTML = '<span class="listing-badge ' + badgeClass + '"><svg viewBox="0 0 24 24"><path d="M17.65 6.35a7.95 7.95 0 0 0-11.3 0L12 12l5.65-5.65zM12 22c5.52 0 10-4.48 10-10h-4c0 3.31-2.69 6-6 6s-6-2.69-6-6H2c0 5.52 4.48 10 10 10z"/></svg>' + (isLive ? 'Ù…Ø²Ø§Ø¯ Ø¬Ø§Ø±Ù' : 'Ù…Ø²Ø§Ø¯') + '</span>' +
        '<div class="auction-info-sm">' + auctionTypeLabel + '</div>';
      var currentBid = (p.bids && p.bids.length > 0) ? p.bids[p.bids.length - 1].amount : p.startPrice;
      priceHTML = '<div style="font-weight:600;">' + formatCurrency(currentBid) + '</div><div class="auction-info-sm">Ø§ÙØªØªØ§Ø­ÙŠ: ' + formatCurrency(p.startPrice) + '</div>';
      if (p.buyNow) priceHTML += '<div class="auction-info-sm">ÙÙˆØ±ÙŠ: ' + formatCurrency(p.buyNow) + '</div>';
    } else {
      listingHTML = '<span class="listing-badge badge-market"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg> Ø³ÙˆÙ‚</span>';
      priceHTML = formatCurrency(p.price);
    }

    html +=
      '<tr>' +
        '<td><div class="product-name-cell"><img class="product-thumb" src="' + p.image + '" alt="' + p.name + '" onerror="this.style.background=\'linear-gradient(135deg,#4A2C1A,#C19A6B)\';this.src=\'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==\'"><span>' + p.name + '</span></div></td>' +
        '<td>' + listingHTML + '</td>' +
        '<td>' + p.category + ' / ' + p.type + '</td>' +
        '<td>' + p.origin + '</td>' +
        '<td style="font-weight:600;">' + priceHTML + '</td>' +
        '<td>' + p.stock + '</td>' +
        '<td>' + (p.active ? '<span class="status status-active"><span class="status-dot"></span>Ù†Ø´Ø·</span>' : '<span class="status status-inactive"><span class="status-dot"></span>Ù…ØªÙˆÙ‚Ù</span>') + '</td>' +
        '<td><div class="action-btns">' +
          '<button class="btn btn-sm btn-outline" onclick="editProduct(\'' + p.id + '\')">ØªØ¹Ø¯ÙŠÙ„</button>' +
          '<button class="btn btn-sm ' + (p.active ? 'btn-warning' : 'btn-success') + '" onclick="toggleProduct(\'' + p.id + '\')">' + (p.active ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„') + '</button>' +
          '<button class="btn btn-sm btn-danger" onclick="deleteProduct(\'' + p.id + '\')">Ø­Ø°Ù</button>' +
        '</div></td>' +
      '</tr>';
  });

  document.getElementById('productsBody').innerHTML = html;
}

// ===== ADD CHOOSER =====
function openAddChooser() {
  document.getElementById('addChooserModal').classList.add('open');
  // Reset selection
  document.querySelectorAll('#addChooserModal .chooser-card').forEach(function(c) { c.classList.remove('selected'); });
}

function closeAddChooser() {
  document.getElementById('addChooserModal').classList.remove('open');
}

function chooseListingType(type) {
  closeAddChooser();
  openProductModal(null, type);
}

function selectAuctionType(type) {
  document.querySelectorAll('.auction-type-btn').forEach(function(btn) {
    btn.classList.toggle('selected', btn.dataset.atype === type);
  });
  // Show/hide duration field
  var durationGroup = document.getElementById('auctionDurationGroup');
  if (type === 'until_sold') {
    durationGroup.style.display = 'none';
  } else {
    durationGroup.style.display = 'block';
  }
}

function updateFormForListingType(type) {
  var auctionFields = document.getElementById('auctionFields');
  var priceGroup = document.getElementById('priceGroup');
  var priceLabelText = document.getElementById('priceLabelText');
  var saveBtn = document.getElementById('saveProductBtn');

  if (type === 'auction') {
    auctionFields.classList.add('visible');
    priceGroup.style.display = 'none';
    priceLabelText.textContent = 'Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)';
    saveBtn.textContent = 'Ø·Ø±Ø­ Ø§Ù„Ù…Ø²Ø§Ø¯';
    document.getElementById('productModalTitle').textContent = document.getElementById('editProductId').value ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ø¯' : 'Ø·Ø±Ø­ Ù…Ø²Ø§Ø¯ Ø¬Ø¯ÙŠØ¯';
  } else {
    auctionFields.classList.remove('visible');
    priceGroup.style.display = 'block';
    priceLabelText.textContent = 'Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)';
    saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
    document.getElementById('productModalTitle').textContent = document.getElementById('editProductId').value ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'Ø·Ø±Ø­ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚';
  }
}

function openProductModal(editId, listingType) {
  document.getElementById('editProductId').value = editId || '';
  var type = listingType || 'market';

  if (editId) {
    var p = currentUser.products.find(function(pr) { return pr.id === editId; });
    if (p) {
      type = p.listingType || 'market';
      document.getElementById('pmName').value = p.name;
      document.getElementById('pmCategory').value = p.category;
      document.getElementById('pmType').value = p.type;
      document.getElementById('pmOrigin').value = p.origin;
      document.getElementById('pmWeight').value = p.weight;
      document.getElementById('pmUnit').value = p.unit;
      document.getElementById('pmPrice').value = p.price;
      document.getElementById('pmStock').value = p.stock;
      document.getElementById('pmImage').value = p.image;
      document.getElementById('pmDesc').value = p.description;

      // Auction fields
      if (type === 'auction') {
        document.getElementById('pmStartPrice').value = p.startPrice || '';
        document.getElementById('pmMinBid').value = p.minBid || '';
        document.getElementById('pmAuctionDuration').value = p.auctionDuration || '3';
        document.getElementById('pmBuyNow').value = p.buyNow || '';
        selectAuctionType(p.auctionType || 'timed');
      }
    }
  } else {
    // Clear form
    ['pmName','pmWeight','pmPrice','pmStock','pmImage','pmDesc','pmStartPrice','pmMinBid','pmBuyNow'].forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.value = '';
    });
    document.getElementById('pmCategory').value = 'Ø¨Ø®ÙˆØ±';
    document.getElementById('pmType').value = 'Ø·Ø¨ÙŠØ¹ÙŠ';
    document.getElementById('pmOrigin').value = 'ÙƒÙ…Ø¨ÙˆØ¯ÙŠ';
    document.getElementById('pmUnit').value = 'Ø¬Ø±Ø§Ù…';
    document.getElementById('pmAuctionDuration').value = '3';
    selectAuctionType('timed');
  }

  document.getElementById('pmListingType').value = type;
  updateFormForListingType(type);
  document.getElementById('productModal').classList.add('open');
}

function closeProductModal() {
  document.getElementById('productModal').classList.remove('open');
}

function saveProduct() {
  var name = document.getElementById('pmName').value.trim();
  var stock = parseInt(document.getElementById('pmStock').value);
  var weight = parseFloat(document.getElementById('pmWeight').value);
  var listingType = document.getElementById('pmListingType').value;

  if (!name) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'error'); return; }
  if (isNaN(stock) || stock < 0) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© Ù…Ø®Ø²ÙˆÙ† ØµØ­ÙŠØ­Ø©', 'error'); return; }

  var editId = document.getElementById('editProductId').value;
  var product = {
    id: editId || 'p_' + Date.now(),
    name: name,
    listingType: listingType,
    category: document.getElementById('pmCategory').value,
    type: document.getElementById('pmType').value,
    origin: document.getElementById('pmOrigin').value,
    weight: weight || 0,
    unit: document.getElementById('pmUnit').value,
    price: 0,
    stock: stock,
    active: true,
    image: document.getElementById('pmImage').value.trim() || 'https://images.unsplash.com/photo-1600857544200-b2f666a9a2ec?w=400&h=300&fit=crop&q=80',
    description: document.getElementById('pmDesc').value.trim(),
    createdAt: new Date().toISOString().split('T')[0]
  };

  if (listingType === 'auction') {
    var startPrice = parseFloat(document.getElementById('pmStartPrice').value);
    var minBid = parseFloat(document.getElementById('pmMinBid').value);
    if (!startPrice || startPrice <= 0) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ', 'error'); return; }
    if (!minBid || minBid <= 0) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø²Ø§ÙŠØ¯Ø©', 'error'); return; }

    var selectedAuctionType = document.querySelector('.auction-type-btn.selected');
    var auctionType = selectedAuctionType ? selectedAuctionType.dataset.atype : 'timed';

    product.startPrice = startPrice;
    product.minBid = minBid;
    product.auctionType = auctionType;
    product.auctionDuration = parseInt(document.getElementById('pmAuctionDuration').value) || 3;
    product.buyNow = parseFloat(document.getElementById('pmBuyNow').value) || 0;
    product.price = startPrice;
    product.auctionStatus = 'live';
    product.auctionStartDate = new Date().toISOString().split('T')[0];

    // Calculate end date for timed auctions
    if (auctionType === 'timed') {
      var endDate = new Date();
      endDate.setDate(endDate.getDate() + product.auctionDuration);
      product.auctionEndDate = endDate.toISOString().split('T')[0];
    } else {
      product.auctionEndDate = null;
    }

    // Keep existing bids on edit, initialize empty on new
    if (editId) {
      var existing = currentUser.products.find(function(p) { return p.id === editId; });
      product.bids = (existing && existing.bids) ? existing.bids : [];
    } else {
      product.bids = [];
      // Add mock bids for demo
      product.bids.push(
        { bidder: 'Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø§Ù„Ù…', amount: startPrice, date: new Date().toISOString() },
        { bidder: 'ÙÙŠØµÙ„ Ø§Ù„Ø¹Ù…Ø±ÙŠ', amount: startPrice + minBid, date: new Date().toISOString() },
        { bidder: 'Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ', amount: startPrice + (minBid * 2), date: new Date().toISOString() }
      );
    }
  } else {
    var price = parseFloat(document.getElementById('pmPrice').value);
    if (!price || price <= 0) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­', 'error'); return; }
    product.price = price;
    product.listingType = 'market';
  }

  // ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ØµÙŠØºØ© Supabase (snake_case)
  var dbProduct = {
    name: product.name,
    listing_type: product.listingType,
    category: product.category,
    type: product.type,
    origin: product.origin,
    weight: product.weight,
    unit: product.unit,
    price: product.price,
    stock: product.stock,
    active: product.active,
    image: product.image,
    description: product.description,
    start_price: product.startPrice || null,
    min_bid: product.minBid || null,
    auction_type: product.auctionType || null,
    auction_duration: product.auctionDuration || null,
    buy_now: product.buyNow || null,
    auction_status: product.auctionStatus || null,
    auction_start_date: product.auctionStartDate || null,
    auction_end_date: product.auctionEndDate || null
  };

  if (editId) {
    AUTH.updateProduct(editId, dbProduct).then(function() {
      showToast(listingType === 'auction' ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø²Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    });
    // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠØ§Ù‹
    var idx = currentUser.products.findIndex(function(p) { return p.id === editId; });
    if (idx !== -1) {
      currentUser.products[idx] = Object.assign(currentUser.products[idx], product);
    }
  } else {
    AUTH.addProduct(dbProduct).then(function(saved) {
      if (saved) {
        product.id = saved.id;
        currentUser.products.push(product);
        renderProducts();
        renderOverview();
      }
    });
    // Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£Ø¶Ù Ù…Ø­Ù„ÙŠØ§Ù‹
    currentUser.products = currentUser.products || [];
    currentUser.products.push(product);
    showToast(listingType === 'auction' ? 'ØªÙ… Ø·Ø±Ø­ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  }

  renderProducts();
  renderOverview();
  closeProductModal();
}

function editProduct(id) {
  var p = currentUser.products.find(function(pr) { return pr.id === id; });
  openProductModal(id, p ? p.listingType : 'market');
}

function toggleProduct(id) {
  var p = currentUser.products.find(function(pr) { return pr.id === id; });
  if (p) {
    p.active = !p.active;
    AUTH.updateProduct(id, { active: p.active });
    renderProducts();
    renderOverview();
    showToast(p.active ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†ØªØ¬', 'success');
  }
}

function deleteProduct(id) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  currentUser.products = currentUser.products.filter(function(p) { return p.id !== id; });
  AUTH.deleteProduct(id);
  renderProducts();
  renderOverview();
  showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'success');
}

// ===== ORDERS =====
function renderOrders() {
  var user = currentUser;
  var orders = user.orders;

  // Counts
  var countNew = orders.filter(function(o) { return o.status === 'new'; }).length;
  var countProcessing = orders.filter(function(o) { return o.status === 'processing'; }).length;
  var countCompleted = orders.filter(function(o) { return o.status === 'completed'; }).length;
  var countCancelled = orders.filter(function(o) { return o.status === 'cancelled'; }).length;

  document.getElementById('countAll').textContent = orders.length;
  document.getElementById('countNew').textContent = countNew;
  document.getElementById('countProcessing').textContent = countProcessing;
  document.getElementById('countCompleted').textContent = countCompleted;
  document.getElementById('countCancelled').textContent = countCancelled;
  document.getElementById('newOrdersCount').textContent = countNew;

  // Filter
  var filtered = orders;
  if (currentOrderFilter !== 'all') {
    filtered = orders.filter(function(o) { return o.status === currentOrderFilter; });
  }

  if (filtered.length === 0) {
    document.getElementById('ordersBody').innerHTML = '<tr><td colspan="9"><div class="empty-state"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h3></div></td></tr>';
    return;
  }

  var html = '';
  filtered.forEach(function(o) {
    var actions = '';
    if (o.status === 'new') {
      actions = '<button class="btn btn-sm btn-success" onclick="acceptOrder(\'' + o.id + '\')">Ù‚Ø¨ÙˆÙ„</button>' +
                '<button class="btn btn-sm btn-danger" onclick="openRejectModal(\'' + o.id + '\')">Ø±ÙØ¶</button>';
    } else if (o.status === 'processing') {
      actions = '<button class="btn btn-sm btn-primary" onclick="openWaybillModal(\'' + o.id + '\')">Ø¨ÙˆÙ„ÙŠØµØ©</button>' +
                '<button class="btn btn-sm btn-success" onclick="updateOrderStatus(\'' + o.id + '\',\'completed\')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>';
    }
    actions += '<button class="btn btn-sm btn-outline" onclick="showOrderDetail(\'' + o.id + '\')">ØªÙØ§ØµÙŠÙ„</button>';

    // Waybill badge
    var waybillBadge = '';
    if (o.waybillGenerated) {
      waybillBadge = ' <span class="shipping-badge">&#10003; Ø¨ÙˆÙ„ÙŠØµØ©</span>';
    } else if (o.status === 'processing') {
      waybillBadge = ' <span class="shipping-badge pending">Ø¨Ø¯ÙˆÙ† Ø¨ÙˆÙ„ÙŠØµØ©</span>';
    }

    html +=
      '<tr>' +
        '<td style="font-weight:600; font-size:0.82rem; direction:ltr; text-align:right;">' + o.id + '</td>' +
        '<td>' + o.productName + '</td>' +
        '<td>' + o.buyer + '</td>' +
        '<td>' + o.qty + '</td>' +
        '<td style="font-weight:600;">' + formatCurrency(o.total) + '</td>' +
        '<td>' + o.shippingMethod + waybillBadge + '</td>' +
        '<td>' + statusLabel(o.status) + '</td>' +
        '<td style="font-size:0.82rem; opacity:0.7;">' + o.date + '</td>' +
        '<td><div class="action-btns">' + actions + '</div></td>' +
      '</tr>';
  });

  document.getElementById('ordersBody').innerHTML = html;
}

function filterOrders(tab) {
  currentOrderFilter = tab;
  document.querySelectorAll('#orderTabs .tab-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  renderOrders();
}

function updateOrderStatus(orderId, newStatus) {
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) return;

  order.status = newStatus;

  // Push to status history
  var statusNotes = { processing: 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', completed: 'ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥ØªÙ…Ø§Ù…Ù‡', cancelled: 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨' };
  order.statusHistory = order.statusHistory || [];
  order.statusHistory.push({
    status: newStatus,
    date: new Date().toISOString(),
    note: statusNotes[newStatus] || 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©'
  });

  // If completed, add transaction
  if (newStatus === 'completed') {
    var commission = order.total * 0.05;
    currentUser.transactions.unshift(
      { id: 't_' + Date.now(), type: 'sale', amount: order.total, date: new Date().toISOString().split('T')[0], ref: order.id, status: 'completed', description: 'Ø¨ÙŠØ¹: ' + order.productName + ' Ã— ' + order.qty },
      { id: 't_' + (Date.now() + 1), type: 'commission', amount: -commission, date: new Date().toISOString().split('T')[0], ref: order.id, status: 'completed', description: 'Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© 5%' }
    );
    currentUser.balance += (order.total - commission);
    currentUser.totalSales += order.qty;
    currentUser.totalRevenue += order.total;
  }

  AUTH.updateUser(currentUser);
  renderOrders();
  renderOverview();
  renderFinance();

  var msgs = { processing: 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', completed: 'ØªÙ… Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨', cancelled: 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨' };
  showToast(msgs[newStatus] || 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
}

// ===== ORDER DETAIL (Enhanced) =====
function showOrderDetail(orderId) {
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) return;

  document.getElementById('orderDetailTitle').textContent = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ' + order.id;

  // 1. Order Info Section
  var html = '<div class="order-detail-section">' +
    '<div class="order-detail-section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ù…Ù†ØªØ¬</label><span>' + order.productName + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><span>' + order.qty + '</span></div>' +
    '<div class="order-detail-row"><label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><span>' + formatCurrency(order.price) + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</label><span>' + formatCurrency(order.total) + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø´Ø­Ù† (' + order.shippingMethod + ')</label><span>' + formatCurrency(order.shipping) + '</span></div>' +
    '<div class="order-detail-row order-detail-total"><label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><span>' + formatCurrency(order.total + order.shipping) + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><span>' + statusLabel(order.status) + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><span>' + order.date + '</span></div>' +
  '</div>';

  // 2. Buyer Address Section
  html += '<div class="order-detail-section">' +
    '<div class="order-detail-section-title">' +
      'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ' +
      (order.status !== 'completed' && order.status !== 'cancelled' ? '<button class="btn btn-sm btn-outline" onclick="toggleAddressEdit(\'' + order.id + '\')">ØªØ¹Ø¯ÙŠÙ„</button>' : '') +
    '</div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø§Ø³Ù…</label><span>' + order.buyer + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø¬ÙˆØ§Ù„</label><span style="direction:ltr;display:inline-block;">' + order.buyerPhone + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><span>' + order.buyerCity + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø­ÙŠ</label><span>' + order.buyerDistrict + '</span></div>' +
    '<div class="order-detail-row"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><span>' + order.buyerStreet + '</span></div>' +
    '<div class="address-edit-form" id="addressEditForm">' +
      '<div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input type="text" class="form-input" id="editCity" value="' + order.buyerCity + '"></div>' +
      '<div class="form-group"><label class="form-label">Ø§Ù„Ø­ÙŠ</label><input type="text" class="form-input" id="editDistrict" value="' + order.buyerDistrict + '"></div>' +
      '<div class="form-group"><label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" class="form-input" id="editStreet" value="' + order.buyerStreet + '"></div>' +
      '<div style="display:flex;gap:8px;margin-top:12px;"><button class="btn btn-sm btn-primary" onclick="saveOrderAddress(\'' + order.id + '\')">Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button><button class="btn btn-sm btn-outline" onclick="toggleAddressEdit(\'' + order.id + '\')">Ø¥Ù„ØºØ§Ø¡</button></div>' +
    '</div>' +
  '</div>';

  // 3. Shipping Info Section (only if not new)
  if (order.status !== 'new') {
    html += '<div class="order-detail-section">' +
      '<div class="order-detail-section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø­Ù†</div>';
    if (order.waybillGenerated) {
      html += '<div class="order-detail-row"><label>Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†</label><span>' + order.carrierName + '</span></div>' +
        '<div class="order-detail-row"><label>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹</label><span style="direction:ltr;display:inline-block;font-weight:700;">' + order.trackingNumber + '</span></div>' +
        '<div class="order-detail-row"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©</label><span>' + order.waybillDate + '</span></div>' +
        '<div class="order-detail-row"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><span class="shipping-badge">&#10003; ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©</span></div>';
    } else if (order.status === 'processing') {
      html += '<div style="text-align:center;padding:16px;"><span class="shipping-badge pending">Ù„Ù… ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± Ø¨ÙˆÙ„ÙŠØµØ© Ø¨Ø¹Ø¯</span>' +
        '<br><button class="btn btn-sm btn-primary" style="margin-top:12px;" onclick="closeOrderDetail();openWaybillModal(\'' + order.id + '\')">Ø¥ØµØ¯Ø§Ø± Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„Ø¢Ù†</button></div>';
    } else if (order.status === 'cancelled') {
      html += '<div class="order-detail-row"><label>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡</label><span style="color:var(--red);">' + (order.cancelReason || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</span></div>';
    }
    html += '</div>';
  }

  // 4. Timeline Section
  var history = order.statusHistory || [];
  if (history.length > 0) {
    html += '<div class="order-detail-section">' +
      '<div class="order-detail-section-title">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ</div>' +
      '<div class="order-timeline">';
    history.forEach(function(h, i) {
      var isLast = i === history.length - 1;
      var dateStr = h.date ? new Date(h.date).toLocaleString('ar-SA', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
      html += '<div class="timeline-item">' +
        '<div class="timeline-dot' + (isLast ? ' active' : '') + '"></div>' +
        '<div class="timeline-content">' +
          '<div class="timeline-date">' + dateStr + '</div>' +
          '<div class="timeline-note">' + (h.note || h.status) + '</div>' +
        '</div>' +
      '</div>';
    });
    html += '</div></div>';
  }

  document.getElementById('orderDetailBody').innerHTML = html;

  // Footer actions based on status
  var footerHTML = '';
  if (order.status === 'new') {
    footerHTML = '<button class="btn btn-success" onclick="acceptOrder(\'' + order.id + '\')">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>' +
                 '<button class="btn btn-danger" onclick="openRejectModal(\'' + order.id + '\')">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>';
  } else if (order.status === 'processing') {
    footerHTML = '<button class="btn btn-primary" onclick="closeOrderDetail();openWaybillModal(\'' + order.id + '\')">Ø¥ØµØ¯Ø§Ø± Ø¨ÙˆÙ„ÙŠØµØ©</button>' +
                 '<button class="btn btn-success" onclick="updateOrderStatus(\'' + order.id + '\',\'completed\');closeOrderDetail();">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>';
  }
  document.getElementById('orderDetailFooter').innerHTML = footerHTML;

  document.getElementById('orderDetailModal').classList.add('open');
}

function closeOrderDetail() {
  document.getElementById('orderDetailModal').classList.remove('open');
}

// ===== ORDER ACTIONS =====
function acceptOrder(orderId) {
  updateOrderStatus(orderId, 'processing');
  closeOrderDetail();
}

function toggleAddressEdit() {
  var form = document.getElementById('addressEditForm');
  if (form) form.classList.toggle('visible');
}

function saveOrderAddress(orderId) {
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) return;
  var city = document.getElementById('editCity').value.trim();
  var district = document.getElementById('editDistrict').value.trim();
  var street = document.getElementById('editStreet').value.trim();
  if (!city || !district || !street) { showToast('Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ø©', 'error'); return; }
  order.buyerCity = city;
  order.buyerDistrict = district;
  order.buyerStreet = street;
  order.statusHistory = order.statusHistory || [];
  order.statusHistory.push({ status: order.status, date: new Date().toISOString(), note: 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„' });
  AUTH.updateUser(currentUser);
  showOrderDetail(orderId);
  showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ===== REJECT ORDER =====
function openRejectModal(orderId) {
  document.getElementById('rejectOrderId').value = orderId;
  document.getElementById('rejectReason').value = 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±';
  document.getElementById('customRejectGroup').style.display = 'none';
  document.getElementById('rejectModal').classList.add('open');
}
function closeRejectModal() { document.getElementById('rejectModal').classList.remove('open'); }
function onRejectReasonChange() {
  document.getElementById('customRejectGroup').style.display =
    document.getElementById('rejectReason').value === 'other' ? 'block' : 'none';
}
function confirmRejectOrder() {
  var orderId = document.getElementById('rejectOrderId').value;
  var reason = document.getElementById('rejectReason').value;
  if (reason === 'other') {
    reason = document.getElementById('rejectCustomReason').value.trim();
    if (!reason) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶', 'error'); return; }
  }
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (order) order.cancelReason = reason;
  updateOrderStatus(orderId, 'cancelled');
  closeRejectModal();
  closeOrderDetail();
}

// ===== WAYBILL =====
function openWaybillModal(orderId) {
  document.getElementById('waybillOrderId').value = orderId;
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) return;
  document.getElementById('waybillCarrier').value = order.carrier || '';
  document.getElementById('waybillTracking').value = order.trackingNumber || '';
  document.getElementById('customCarrierGroup').style.display = order.carrier === 'other' ? 'block' : 'none';
  if (order.carrier === 'other' && order.carrierName) {
    document.getElementById('waybillCustomCarrier').value = order.carrierName;
  }
  updateWaybillPreview();
  document.getElementById('waybillModal').classList.add('open');
}
function closeWaybillModal() { document.getElementById('waybillModal').classList.remove('open'); }
function onWaybillCarrierChange() {
  document.getElementById('customCarrierGroup').style.display =
    document.getElementById('waybillCarrier').value === 'other' ? 'block' : 'none';
  updateWaybillPreview();
}
function updateWaybillPreview() {
  var orderId = document.getElementById('waybillOrderId').value;
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) { document.getElementById('waybillPreview').innerHTML = ''; return; }
  var carrier = document.getElementById('waybillCarrier').value;
  var tracking = document.getElementById('waybillTracking').value;
  var carrierLogos = {
    aramex: { name: 'Aramex - \u0623\u0631\u0627\u0645\u0643\u0633', color: '#E74C3C' },
    smsa: { name: 'SMSA Express', color: '#1A73E8' },
    spl: { name: '\u0627\u0644\u0628\u0631\u064a\u062f \u0627\u0644\u0633\u0639\u0648\u062f\u064a - SPL', color: '#4A7C59' },
    other: { name: document.getElementById('waybillCustomCarrier').value || '\u0634\u0631\u0643\u0629 \u0634\u062d\u0646', color: '#666' }
  };
  var ci = carrierLogos[carrier] || { name: 'Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†', color: '#999' };
  var senderName = currentUser.firstName + ' ' + currentUser.lastName;
  var storeName = currentUser.storeName || 'ØµÙŠØ¯Ø§Øª Ø§Ù„Ø¹ÙˆØ¯';
  var senderPhone = currentUser.phone || '';

  var h = '<div class="waybill-page">' +
    '<div class="waybill-header">' +
      '<div class="waybill-carrier-logo" style="border-color:' + ci.color + ';color:' + ci.color + ';">' + ci.name + '</div>' +
      '<div class="waybill-barcode-area">' +
        '<div class="waybill-order-id">' + order.id + '</div>' +
        '<div class="waybill-barcode-placeholder">||||| |||| ||||| ||||</div>' +
        (tracking ? '<div class="waybill-tracking-num">' + tracking + '</div>' : '') +
      '</div>' +
    '</div>' +
    '<div class="waybill-section"><div class="waybill-section-title">Ø§Ù„Ù…Ø±Ø³Ù„</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø§Ø³Ù…:</span> ' + senderName + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ù…ØªØ¬Ø±:</span> ' + storeName + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span style="direction:ltr;display:inline-block;">' + senderPhone + '</span></div>' +
    '</div>' +
    '<div class="waybill-section"><div class="waybill-section-title">Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø§Ø³Ù…:</span> ' + order.buyer + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span style="direction:ltr;display:inline-block;">' + order.buyerPhone + '</span></div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</span> ' + order.buyerCity + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø­ÙŠ:</span> ' + order.buyerDistrict + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span> ' + order.buyerStreet + '</div>' +
    '</div>' +
    '<div class="waybill-section"><div class="waybill-section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø©</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ù…Ù†ØªØ¬:</span> ' + order.productName + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„ÙƒÙ…ÙŠØ©:</span> ' + order.qty + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ù‚ÙŠÙ…Ø©:</span> ' + formatCurrency(order.total) + '</div>' +
      '<div class="waybill-row"><span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´Ø­Ù†:</span> ' + order.shippingMethod + '</div>' +
      '<div class="waybill-row"><span>Ø§Ù„Ø¯ÙØ¹:</span> Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>' +
    '</div>' +
    '<div class="waybill-footer"><span>ØµÙŠØ¯Ø§Øª Ø§Ù„Ø¹ÙˆØ¯</span><span>' + new Date().toISOString().split('T')[0] + '</span></div>' +
  '</div>';

  document.getElementById('waybillPreview').innerHTML = h;
}

function saveAndPrintWaybill() {
  var orderId = document.getElementById('waybillOrderId').value;
  var carrier = document.getElementById('waybillCarrier').value;
  var tracking = document.getElementById('waybillTracking').value.trim();
  if (!carrier) { showToast('Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†', 'error'); return; }
  if (!tracking) { showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹', 'error'); return; }
  var carrierName = '';
  var opt = document.querySelector('#waybillCarrier option:checked');
  if (opt) carrierName = opt.textContent;
  if (carrier === 'other') {
    carrierName = document.getElementById('waybillCustomCarrier').value.trim();
    if (!carrierName) { showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ø´Ø­Ù†', 'error'); return; }
  }
  var order = currentUser.orders.find(function(o) { return o.id === orderId; });
  if (!order) return;
  order.carrier = carrier;
  order.carrierName = carrierName;
  order.trackingNumber = tracking;
  order.waybillGenerated = true;
  order.waybillDate = new Date().toISOString().split('T')[0];
  order.statusHistory = order.statusHistory || [];
  order.statusHistory.push({ status: order.status, date: new Date().toISOString(), note: 'ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø¨ÙˆÙ„ÙŠØµØ© Ø§Ù„Ø´Ø­Ù† - ' + carrierName + ' - ' + tracking });
  AUTH.updateUser(currentUser);
  renderOrders();
  showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†', 'success');
  // Update preview then print
  updateWaybillPreview();
  setTimeout(function() { window.print(); }, 300);
}

// ===== FINANCE =====
function renderFinance() {
  var user = currentUser;

  document.getElementById('balanceAmount').innerHTML = formatNumber(user.balance) + ' <span>Ø±.Ø³</span>';

  // Calculate stats
  var thisMonthSales = user.transactions.filter(function(t) {
    return t.type === 'sale' && t.date.startsWith('2026-02');
  }).reduce(function(sum, t) { return sum + t.amount; }, 0);

  var totalCommission = user.transactions.filter(function(t) {
    return t.type === 'commission';
  }).reduce(function(sum, t) { return sum + Math.abs(t.amount); }, 0);

  var netProfit = user.totalRevenue - totalCommission;

  document.getElementById('financeStats').innerHTML =
    '<div class="finance-stat"><div class="finance-stat-value">' + formatCurrency(thisMonthSales) + '</div><div class="finance-stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div></div>' +
    '<div class="finance-stat"><div class="finance-stat-value" style="color:#F39C12;">' + formatCurrency(totalCommission) + '</div><div class="finance-stat-label">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø© (5%)</div></div>' +
    '<div class="finance-stat"><div class="finance-stat-value" style="color:#27AE60;">' + formatCurrency(netProfit) + '</div><div class="finance-stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div></div>';

  // Transactions table
  var html = '';
  user.transactions.forEach(function(t) {
    var amountClass = t.amount >= 0 ? 'color:#27AE60;' : 'color:#E74C3C;';
    var amountPrefix = t.amount >= 0 ? '+' : '';
    html +=
      '<tr>' +
        '<td style="font-size:0.82rem; opacity:0.7;">' + t.date + '</td>' +
        '<td>' + typeLabel(t.type) + '</td>' +
        '<td>' + t.description + '</td>' +
        '<td style="font-weight:700;' + amountClass + '">' + amountPrefix + formatCurrency(t.amount) + '</td>' +
        '<td style="font-size:0.82rem; direction:ltr; text-align:right;">' + t.ref + '</td>' +
        '<td>' + statusLabel(t.status) + '</td>' +
      '</tr>';
  });
  document.getElementById('transactionsBody').innerHTML = html;
}

function openWithdrawModal() {
  document.getElementById('withdrawAmount').value = '';
  document.getElementById('withdrawBank').value = currentUser.bankName || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ';
  document.getElementById('withdrawIban').value = currentUser.iban || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†';
  document.getElementById('withdrawModal').classList.add('open');
}

function closeWithdrawModal() {
  document.getElementById('withdrawModal').classList.remove('open');
}

function submitWithdraw() {
  var amount = parseFloat(document.getElementById('withdrawAmount').value);
  if (!amount || amount < 100) {
    showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ 100 Ø±.Ø³', 'error');
    return;
  }
  if (amount > currentUser.balance) {
    showToast('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­', 'error');
    return;
  }
  if (!currentUser.iban) {
    showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø¨Ù†ÙƒÙŠØ© Ø£ÙˆÙ„Ø§Ù‹', 'error');
    return;
  }

  currentUser.balance -= amount;
  currentUser.transactions.unshift({
    id: 't_' + Date.now(),
    type: 'withdrawal',
    amount: -amount,
    date: new Date().toISOString().split('T')[0],
    ref: 'W-' + Math.floor(Math.random() * 999 + 1).toString().padStart(3, '0'),
    status: 'completed',
    description: 'Ø³Ø­Ø¨ Ø¥Ù„Ù‰ ' + currentUser.bankName
  });

  AUTH.updateUser(currentUser);
  renderFinance();
  renderOverview();
  closeWithdrawModal();
  showToast('ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø®Ù„Ø§Ù„ 1-3 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„', 'success');
}

// ===== PROFILE =====
function loadProfile() {
  var user = currentUser;
  document.getElementById('profileAvatar').textContent = user.firstName.charAt(0);
  document.getElementById('profileFullName').textContent = user.firstName + ' ' + user.lastName;
  document.getElementById('profFirstName').value = user.firstName;
  document.getElementById('profLastName').value = user.lastName;
  document.getElementById('profEmail').value = user.email;
  document.getElementById('profPhone').value = user.phone;
  document.getElementById('profStoreName').value = user.storeName || '';
  document.getElementById('profStoreDesc').value = user.storeDesc || '';
  document.getElementById('profBankName').value = user.bankName || '';
  document.getElementById('profBankHolder').value = user.bankHolder || '';
  document.getElementById('profIban').value = user.iban || '';
  document.getElementById('profCurrentPass').value = '';
  document.getElementById('profNewPass').value = '';
  document.getElementById('profConfirmPass').value = '';

  // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ«ÙŠÙ‚
  document.getElementById('profCommercialRegister').value = user.commercialRegister || '';

  // Ø´Ø§Ø±Ø© Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…ÙˆØ«Ù‚
  var merchantBadge = document.getElementById('merchantBadge');
  var merchantForm = document.getElementById('merchantVerifyForm');
  if (user.merchantVerified) {
    merchantBadge.textContent = 'Ù…ÙˆØ«Ù‚ âœ“';
    merchantBadge.className = 'verify-badge verified';
    merchantForm.style.display = 'none';
  } else if (user.commercialRegister) {
    merchantBadge.textContent = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    merchantBadge.className = 'verify-badge pending';
    merchantForm.style.display = 'none';
  } else {
    merchantBadge.textContent = 'ØºÙŠØ± Ù…ÙˆØ«Ù‚';
    merchantBadge.className = 'verify-badge';
    merchantForm.style.display = 'block';
  }

  // Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø§Ù„Ù…ÙˆØ«Ù‚
  var sellerBadge = document.getElementById('sellerBadge');
  var completed = user.completedAuctions || 0;
  var progress = Math.min(completed / 2 * 100, 100);
  document.getElementById('auctionProgressFill').style.width = progress + '%';
  document.getElementById('auctionProgressText').textContent = completed + ' / 2 Ù…Ø²Ø§Ø¯ Ù…ÙƒØªÙ…Ù„';
  if (user.sellerVerified) {
    sellerBadge.textContent = 'Ù…ÙˆØ«Ù‚ âœ“';
    sellerBadge.className = 'verify-badge verified';
  } else {
    sellerBadge.textContent = 'ØºÙŠØ± Ù…ÙˆØ«Ù‚';
    sellerBadge.className = 'verify-badge';
  }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚ ØªØ§Ø¬Ø±
function submitMerchantVerification() {
  var register = document.getElementById('profCommercialRegister').value.trim();
  if (!register) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ', 'error'); return; }
  currentUser.commercialRegister = register;
  AUTH.updateUser({ commercialRegister: register });
  loadProfile();
  showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ - Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'success');
}

function saveProfile() {
  var firstName = document.getElementById('profFirstName').value.trim();
  var lastName = document.getElementById('profLastName').value.trim();
  if (!firstName || !lastName) { showToast('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'error'); return; }

  currentUser.firstName = firstName;
  currentUser.lastName = lastName;
  currentUser.email = document.getElementById('profEmail').value.trim();
  currentUser.phone = document.getElementById('profPhone').value.trim();
  currentUser.storeName = document.getElementById('profStoreName').value.trim();
  currentUser.storeDesc = document.getElementById('profStoreDesc').value.trim();
  currentUser.bankName = document.getElementById('profBankName').value;
  currentUser.bankHolder = document.getElementById('profBankHolder').value.trim();
  currentUser.iban = document.getElementById('profIban').value.trim();

  // Password change
  var currentPass = document.getElementById('profCurrentPass').value;
  var newPass = document.getElementById('profNewPass').value;
  var confirmPass = document.getElementById('profConfirmPass').value;

  if (currentPass || newPass || confirmPass) {
    if (btoa(currentPass) !== currentUser.password) {
      showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      return;
    }
    if (newPass.length < 6) {
      showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      return;
    }
    if (newPass !== confirmPass) {
      showToast('ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', 'error');
      return;
    }
    currentUser.password = btoa(newPass);
  }

  AUTH.updateUser(currentUser);
  updateSidebar();
  loadProfile();
  showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
}

// ===== TOAST =====
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast ' + (type || '') + ' show';
  setTimeout(function() {
    toast.className = 'toast';
  }, 3000);
}

// ===== INIT =====
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initDashboard);
} else {
  initDashboard();
}

// Listen for hash changes
window.addEventListener('hashchange', function() {
  var hash = window.location.hash.replace('#', '');
  if (hash && document.getElementById('section-' + hash)) {
    switchSection(hash);
  }
});
</script>
</body>
</html>
